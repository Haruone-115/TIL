# React: 関数内コンポーネント定義で起きる 1 文字入力バグの話

## 問題: 1 文字しか入力できない！

```tsx
const Parent = () => {
  const [value, setValue] = useState("");

  // ❌ これがダメ！
  const InputComponent = () => (
    <input value={value} onChange={(e) => setValue(e.target.value)} />
  );

  return <InputComponent />;
};
```

**現象:**

- 1 文字入力するとフォーカスが外れる
- 連続入力できない

## 原因: React の差分検出の仕組み

### 1. React は「型（関数の参照）」で判断

```javascript
function Parent() {
  const Child = () => <div />; // 毎回新しい関数が作られる
  return <Child />;
}

// 1回目: Child_v1 (メモリアドレス: 0x1000)
// 2回目: Child_v2 (メモリアドレス: 0x2000)
// → 0x1000 ≠ 0x2000 → 「違う型だ！」
```

### 2. 型が違う → アンマウント & マウント

```
同じ型   → 既存インスタンスを更新（props だけ変更）
違う型   → 破棄して新規作成（フォーカス失われる）
```

## 動作フロー

```
ユーザーが "A" を入力
  ↓
onChange → setValue("A")
  ↓
再レンダリング
  ↓
Parent が再実行
  ↓
InputComponent = 新しい関数（新しい参照）
  ↓
React: 「前回と違う型だ！」
  ↓
古い <input> をアンマウント（DOM削除）
  ↓
フォーカス失われる 😱
  ↓
新しい <input> をマウント
  ↓
フォーカスなし → 1文字しか入力できない
```

## 解決策: モジュールレベルで定義

```tsx
// ✅ ファイルの最上位で定義
const InputComponent = ({ value, onChange }) => (
  <input value={value} onChange={onChange} />
);

const Parent = () => {
  const [value, setValue] = useState("");

  return (
    <InputComponent value={value} onChange={(e) => setValue(e.target.value)} />
  );
};
```

**理由:**

- 関数が 1 度だけ作られる（同じ参照を使い回す）
- React: 「同じ型だ！」→ 更新のみ
- フォーカス維持される ✨

## 確認方法: React DevTools

```
React DevTools → Settings →
  ✅ Highlight updates when components render
```

**関数内定義:**

- 1 文字入力 → コンポーネント全体がマウント/アンマウント

**モジュールレベル定義:**

- 1 文字入力 → 通常の更新

## まとめ

| 項目             | 関数内定義 ❌           | モジュールレベル定義 ✅ |
| ---------------- | ----------------------- | ----------------------- |
| 毎回新しい関数？ | Yes                     | No                      |
| React の判断     | 違う型                  | 同じ型                  |
| 動作             | アンマウント → マウント | 更新のみ                |
| フォーカス       | 失われる                | 維持される              |
| パフォーマンス   | 遅い（10-50ms）         | 速い（1-5ms）           |

## 教訓

**React コンポーネントは必ずモジュールレベル（ファイルの最上位）で定義すること！**

理由:

1. JavaScript の関数は毎回新しいオブジェクトとして作られる
2. React は関数の参照で型を判断する
3. 型が変わる → アンマウント/マウント → 副作用発生

---

### 参考: 実際に遭遇したケース

セミナー入力コンポーネントに `showWrapper` を追加した際、
コンテンツ部分を変数 → React コンポーネントに変更。
その時、関数内で定義してしまい、この問題が発生。

**修正内容:** コンポーネントをモジュールレベルに移動
→ 問題解決！
