# MongoDB の ObjectID 形式について

## 問題

rails -> react に渡すとき、view ファイルで以下のように渡していた

```erb
<%= react_component('ActivityDetection.Rules.Webhooks', {
  siteName: @site.name,
  ruleId: @rule.id,
  ruleName: @rule.name
}) %>
```

react 側で受け取った値は、こんな感じになっていた(ruleId = activityDetectionRuleId)

```javaScript
{
  "siteName": "c21090100000",
  "ruleName": "行動検知ルール1",
  "activityDetectionRuleId": {
    "$oid": "689c4a0b644a22c5ef23663e"
  }
}
```

そのまま id を渡してしまうと、MongoDB の ObjectID 形式で渡すようになってしまう
graphql に `{"$oid": "689c4a0b644a22c5ef23663e"}` という形で値を渡しても、id のみが渡っているわけではないのでエラーが発生してしまった

## 解決

そこで、rails -> react へ渡すタイミングで、以下のようにしてあげた

```erb
<%= react_component('ActivityDetection.Rules.Webhooks', {
  siteName: @site.name,
  ruleId: @rule.id.to_s,
  ruleName: @rule.name
}) %>
```

すると、id だけが上手く取り出せるようになった

```javaScript
{
  "siteName": "c21090100000",
  "ruleName": "行動検知ルール1",
  "activityDetectionRuleId": "689c4a0b644a22c5ef23663e",
}
```

## なぜ？

MongoDB の ObjectID は、Rails で `BSON::ObjectId` オブジェクトとして扱われる
このオブジェクトが JSON にシリアライズされるとき、以下のような変換が行われる

```ruby
# Rails側でのObjectID
@rule.id
# => #<BSON::ObjectId:0x000... @data="689c4a0b644a22c5ef23663e">

# JSONシリアライズ時の自動変換
@rule.id.as_json
# => {"$oid" => "689c4a0b644a22c5ef23663e"}
```

これを to_s すると、こうなる

```ruby
# 修正前
ruleId: @rule.id
# JSONに変換される際: {"$oid": "689c4a0b644a22c5ef23663e"}

# 修正後
ruleId: @rule.id.to_s
# JSONに変換される際: "689c4a0b644a22c5ef23663e"
```
